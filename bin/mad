#!/usr/bin/env bash

VERSION="0.1.0"

#
# Display <page> with lookup via MAD_PATH.
#

display() {
  IFS=":"
  local page=$1
  local paths="$MAD_PATH:/usr/local/share/mad:/usr/share/mad:."

  for path in $paths; do
    local file=$path/$page
    local ext=$path/$page.md
    test -f $file && display_file $file
    test -f $ext && display_file $ext
  done

  echo
  echo "  Failed to locate '$page'"
  echo
  echo "    MAD_PATH=\"$paths\""
  echo
  exit 1
}

#
# Display <file>
#

display_file() {
  cat $1 \
    | perl -pe 's|^#+ *(.+)|\e[1m\1\e[0m|g' \
    | perl -pe 's|`(.+?)`|\e[90m\1\e[0m|g' \
    | perl -pe 's|\*\*(.+?)\*\*|\e[1m\1\e[0m|g' \
    | perl -pe 's|__(.+?)__|\e[1m\1\e[0m|g' \
    | perl -pe 's|\*(.+?)\*|\e[4m\1\e[0m|g' \
    | perl -pe 's|_(.+?)_|\e[4m\1\e[0m|g' \
    | perl -pe 's|    (.+)|    \e[90m\1\e[0m|g' \
    | perl -pe 's|^|  |' \
    | less -R
  exit
}

#
# Display the usage for mad(1).
#

display_mad_usage() {
  display_file $(dirname $0)/../share/mad/mad.md
  exit
}

# file required

test $# -eq 0 && display_mad_usage

# parse args

case $1 in
  -v|--version)
    echo $VERSION
    ;;
  -h|--help|help)
    display_mad_usage
    ;;
  *)
    display $1
    ;;
esac